plugins {
  id "com.itiviti.dotnet" version "1.7.2"
  id 'com.nwalsh.gradle.saxon.saxon-gradle' version '0.9.3'
}

import com.nwalsh.gradle.saxon.SaxonXsltTask

// Find dotnet
def dotnetex = null
// Laboriously construct a search path that includes some default locations
// plus the users actual path.
def spath = ["/usr/local/share/dotnet"]
System.getenv("PATH").split(System.getProperty("path.separator")).each { dir ->
  spath += [dir]
}
spath.each { dir ->
  if (dotnetex == null) {
    def fn = new File(dir + "/dotnet")
    if (fn.exists() && fn.canExecute()) {
      dotnetex = fn.toString()
    } else {
      fn = new File(dir + "/dotnet.exe")
      if (fn.exists() && fn.canExecute()) {
        dotnetex = fn.toString()
      }
    }
  }
}

if (dotnetex == null) {
  println("WARNING: Failed to find dotnet[.exe]!")
}

// You must specify the key and source externally in order to push the
// nuget package. For example, they can be read from
// ~/.gradle/gradle.properties. They must not be committed to the
// repository!
if (!hasProperty("nugetApiKey")) {
  ext.nugetApiKey = "KEYREQUIREDTOPUSH"
}
if (!hasProperty("nugetSource")) {
  ext.nugetSource = "SOURCEREQUIREDTOPUSH"
}

dotnet {
  dotnetExecutable = dotnetex
  solution = 'XmlResolver/XmlResolver.sln'
  configuration = 'Release'
  verbosity = 'Normal'
  projectName = 'XmlResolver'

  restore {
  }

  build {
  }  

  nugetPush {
    apiKey = nugetApiKey
    source = nugetSource
  }

  test {
    collectCoverage = true
    nunit {
      testOutputXml = file("${buildDir}/reports/nunit")
    }
  }
}

task dist(type: Exec, dependsOn: ["dotnetBuild"]) {
  environment "CSHARP_XMLRESOLVER_ROOT", projectDir
  commandLine dotnetex, "test", "XmlResolver/UnitTests/UnitTests.csproj"
}
